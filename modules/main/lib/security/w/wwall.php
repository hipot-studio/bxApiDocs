<? namespace Bitrix\Main\Security\W;$GLOBALS['____1704901032']= array(base64_decode('dG'.'lt'.'ZQ='.'='),base64_decode('dGl'.'t'.'ZQ'.'=='),base64_decode(''.'an'.'Nvb'.'l9kZWNvZGU='),base64_decode('Y'.'XJyYXlfb'.'WVy'.'Z2U='),base64_decode('am9pbg=='),base64_decode(''.'am9pbg=='),base64_decode('am9pbg=='),base64_decode('YXJ'.'yYXlfcG9w'),base64_decode('Y'.'XJyY'.'X'.'lfc2hpZnQ='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('YXJyYXlfc2h'.'pZnQ='),base64_decode('YXJyYX'.'l'.'fc'.'2hp'.'Z'.'n'.'Q='),base64_decode('YXJ'.'yYXlf'.'bW'.'VyZ2U='),base64_decode(''.'aXNfY'.'XJyY'.'Xk'.'='),base64_decode('YXJyYXlfbWVyZ2U='),base64_decode('aW5f'.'YXJyYXk='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJyYXk='),base64_decode('a'.'W'.'5'.'fYXJyYXk='),base64_decode(''.'a'.'W5f'.'YXJyYXk='),base64_decode('d'.'G'.'ltZQ='.'='),base64_decode('dGltZQ'.'=='),base64_decode('YXJyYX'.'lfbWFw'),base64_decode(''.'Z2V0X2xvYWRlZF9leHR'.'lbnNpb25z'),base64_decode('anNvbl9'.'l'.'b'.'mNvZGU'.'='),base64_decode('anNvbl9l'.'b'.'m'.'NvZ'.'GU='),base64_decode('c'.'Gh'.'wd'.'mVyc2'.'lv'.'bg=='),base64_decode('anNvbl9lbmNvZ'.'GU='),base64_decode(''.'am'.'9pbg=='));if(!function_exists(__NAMESPACE__.'\\___1867232655')){function ___1867232655($_340503783){static $_1992571900= false; if($_1992571900 == false) $_1992571900=array('V1d'.'BTExfTE9DSw'.'==','c2VjdXJpdHk=','REFUQQ==','ey'.'I=','V1dBTExfT'.'E9D'.'S'.'w==','c'.'2VjdXJpdHk=','U0VDVVJ'.'JVFl'.'fV1dBT'.'ExfRVhDRVBUSU9O',''.'RkFJ'.'TF9DSE'.'VDS'.'0lORw==','Q2FuI'.'G5vd'.'CBleGV'.'jdXRlI'.'Hd3'.'Y'.'W'.'xsIHJ1'.'bGVzOiA=','IFRy'.'YW'.'Nl'.'OiA=','UkVRV'.'UVTVF9'.'V'.'Ukk'.'=','a2'.'V'.'5c'.'w==','dmFsdWVz','U'.'0V'.'DVVJJV'.'FlfV1dBTE'.'xfTU9ESU'.'ZZ','L'.'g==',''.'U'.'0VDVV'.'J'.'J'.'VFlfV1dBTE'.'x'.'f'.'V'.'U5T'.'RVQ=',''.'L'.'g==','U0VDVVJJVFlfV1d'.'BTExfRVhJVA==','Lg==','Z'.'2xv'.'YmFs','a'.'2'.'V5cw='.'=','dm'.'FsdWV'.'z','Z2V0',''.'Z'.'2V0','c'.'G'.'9z'.'d'.'A==','cG9'.'zd'.'A='.'=','Y29va2ll','Y29va2'.'l'.'l','cmVxdWVzdA==','cm'.'VxdW'.'VzdA==','Z2xvYmFs','Z'.'2xvYmFs','bWFpbl9zZW'.'M=','V1dBTExf'.'QUNUV'.'UFMS'.'VpFX1'.'JVT'.'EVT','dg==','dmV'.'yc2lv'.'bg==','aQ==',''.'aXNJbn'.'N'.'0Y'.'WxsZW'.'Q=','dg==',''.'aW5p','c29'.'j'.'a2V0VGlt'.'Z'.'W'.'91'.'dA==','c3RyZ'.'WFtVGltZW'.'91d'.'A==',''.'KCc=','Z'.'G'.'F0'.'YQ==','Jyw'.'gJw'.'==',''.'bW9kdWxl','JywgJw'.'==','b'.'W9'.'kd'.'WxlX3Z'.'lcnNpb24'.'=','Jy'.'k=',''.'LCA'.'=','U0'.'VDVV'.'JJV'.'FlfV1dBTE'.'xf'.'RVhDRVBUSU9O','b'.'WFp'.'bg='.'=','RkFJT'.'F9'.'SRU'.'ZS'.'RVNISU5'.'H','Q2FuIG5vd'.'C'.'ByZW'.'ZyZXNoIHd3Y'.'WxsIHJ1'.'bGV'.'z'.'OiA=',''.'I'.'FR'.'yYWNlOiA=','Z'.'G'.'F0YQ='.'=','ey'.'I=','LS0tL'.'S1CRUd'.'JTiB'.'QVUJMS'.'UMgS0VZ'.'LS0tLS'.'0=','Ck1J'.'SUJJa'.'kFO'.'QmdrcWh'.'raU'.'c5dz'.'B'.'CQVFFRkFBT0NBUT'.'hBTUlJQkNnS0'.'NB'.'U'.'UV'.'B'.'cThRRTBI'.'am1'.'ISlVTdFdWNm4'.'wemEKUlZvTHgwM'.'k'.'t6Ym'.'Z'.'yYl'.'M'.'vUD'.'ZzV2F4VHp3OFNlR1'.'R0YlR'.'D'.'T3J'.'wS'.'Gk1U'.'U'.'Y2'.'T1J5a'.'lovWHh6L0tMVT'.'FHYm9mOU'.'Na'.'Mwo'.'0e'.'jdTa3FVdDY2a'.'WJYdk9GQn'.'g0Znc'.'vQV'.'BQ'.'Ukd'.'EcXRtMG5EM2ZnR3N1M1JlUGd3MjlpOCt'.'2bTdtdEJLSlVZb'.'DRyCl'.'ZwYjZzZ'.'lpF'.'VDlLRWI2'.'VDFIR'.'F'.'ltR'.'XZjMWhx'.'L2lpd'.'Xl'.'4THJaWm'.'k1'.'UTZVZmY0V'.'UV2'.'VEkrN'.'jhzc'.'0ZSa1Erb3dUUn'.'kKZ'.'U9JT'.'W'.'J'.'GaE'.'0v'.'VVRt'.'ZlZZYlRSRn'.'k'.'y'.'b1'.'VROFdNemEybko1U2'.'FoemkxV'.'UtPM'.'W'.'pBalhUUFJyemM3QW'.'p1NjM5'.'ajFPM'.'ApwcH'.'FmbTV4'.'Z1'.'dsRkFKa0hRVGdiZGQ1QVd'.'xREZRa3Q5'.'SEtrWStUbmZ'.'CT'.'EdWTX'.'Z'.'WeVB'.'3VEhOV1'.'FZQXc0eH'.'BnL'.'3dBClp3SURB'.'UUFC'.'Ci'.'0t'.'LS0'.'tRU'.'5EIFBVQkxJ'.'QyBLRVktLS0tLQ==');return base64_decode($_1992571900[$_340503783]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_696776552= 'https://wwall.bitrix.info/rules.php'; protected $_1649873026= true; public function handle(){ try{  $_641481598= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_641481598)){ return;}  $_1075247823= Cache::createInstance(); $_339539122= false; if($_1075247823->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_652276015= $_1075247823->getVars(); if($GLOBALS['____1704901032'][0]()- $_652276015> round(0+4+4+4+4+4)){  $_964349925= Application::getConnection(); $_267833064= RuleRecordTable::getTableName(); $_964349925->truncateTable($_267833064); RuleRecordTable::cleanCache(); $_1075247823->clean(___1867232655(0), ___1867232655(1));}} elseif($_1075247823->startDataCache()){  $_1075247823->endDataCache($GLOBALS['____1704901032'][1]()); $_339539122= true;} foreach($_641481598 as $_1367081184){ $_684703035= new PublicKeyCipher; $_366204908= $_684703035->decrypt($_1367081184[___1867232655(2)], static::__529712830()); if(!str_starts_with($_366204908, ___1867232655(3))){ continue;} $_987680854= $GLOBALS['____1704901032'][2]($_366204908, true); if(!empty($_987680854)){ $_712701190= Rule::make($_987680854); $_1085032014= $this->handleRule($_712701190); $this->applyHandlingResults($_1085032014);}}  if($_339539122){ $_1075247823->clean(___1867232655(4), ___1867232655(5));}} catch(\Throwable $_1939823198){ $this->logEvent( ___1867232655(6), ___1867232655(7), ___1867232655(8). $_1939823198->getMessage(). ___1867232655(9). $_1939823198->getTraceAsString());}}  public function handleRule(Rule $_712701190): array{ $_1085032014=[]; if($_712701190->matchPath($_SERVER[___1867232655(10)])){  $_2097196827= $this->getContextElements($_712701190->getContext()); foreach($_2097196827 as $_788476424 => &$_1715375741){ $_1085032014= $GLOBALS['____1704901032'][3]($_1085032014, $this->recursiveContextKeyHandle($_788476424, $_1715375741,[], $_712701190));}} return $_1085032014;}  public function applyHandlingResults(array $_1085032014){ $_2097196827= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1085032014 as $_136746157){ $_1715375741=& $_2097196827[$_136746157->getContextName()]; $_1351813766= $_136746157->getRuleResult(); $_712701190= $_136746157->getRule(); if($_1351813766 instanceof ModifyResult){ if($_712701190->getProcess() === ___1867232655(11)){  static::rewriteContextKey( $_136746157->getContextName(), $_1715375741, $_136746157->getContextKey(), $_1351813766->getCleanValue());} elseif($_712701190->getProcess() === ___1867232655(12)){ static::rewriteContextValue( $_136746157->getContextName(), $_1715375741, $_136746157->getContextKey(), $_1351813766->getCleanValue());} $this->logEvent( ___1867232655(13), $_136746157->getContextName(), $GLOBALS['____1704901032'][4](___1867232655(14), $_136746157->getContextKey()));} elseif($_1351813766 instanceof CheckResult &&!$_1351813766->isSuccess()){ if($_1351813766->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_136746157->getContextName(), $_1715375741, $_136746157->getContextKey(),); $this->logEvent( ___1867232655(15), $_136746157->getContextName(), $GLOBALS['____1704901032'][5](___1867232655(16), $_136746157->getContextKey()));} elseif($_1351813766->getAction() === RuleAction::EXIT){ $this->logEvent( ___1867232655(17), $_136746157->getContextName(), $GLOBALS['____1704901032'][6](___1867232655(18), $_136746157->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1649873026= false;} protected function rewriteContextKey($_788476424, &$_1715375741, $_1789126238, $_1085061738){ $_1564292105= $_1789126238;  $GLOBALS['____1704901032'][7]($_1564292105); $_1564292105[]= $_1085061738; if($_788476424 === ___1867232655(19)){ $_1486352180= $GLOBALS['____1704901032'][8]($_1789126238); $GLOBALS['____1704901032'][9]($_1564292105); if(empty($_1789126238)){ $GLOBALS[$_1085061738]= $GLOBALS[$_1486352180]; unset($GLOBALS[$_1486352180]);} else{ $_1715375741=& $GLOBALS[$_1486352180]; $_618384366= ArrayHelper::getByNestedKey($_1715375741, $_1789126238);  ArrayHelper::setByNestedKey($_1715375741, $_1564292105, $_618384366);  ArrayHelper::unsetByNestedKey($_1715375741, $_1789126238);}} else{ $_618384366= ArrayHelper::getByNestedKey($_1715375741, $_1789126238);  ArrayHelper::setByNestedKey($_1715375741, $_1564292105, $_618384366);  ArrayHelper::unsetByNestedKey($_1715375741, $_1789126238);}} protected function rewriteContextValue($_788476424, &$_1715375741, $_1023989872, $_618384366){ if($_788476424 === 'global'){ $_1486352180= $GLOBALS['____1704901032'][10]($_1023989872); if(empty($_1023989872)){ $GLOBALS[$_1486352180]= $_618384366;} else{ $_1715375741=& $GLOBALS[$_1486352180]; ArrayHelper::setByNestedKey($_1715375741, $_1023989872, $_618384366);}} else{  ArrayHelper::setByNestedKey($_1715375741, $_1023989872, $_618384366);}} protected function unsetContextValue($_788476424, &$_1715375741, $_1023989872){ if($_788476424 === 'global'){ $_1486352180= $GLOBALS['____1704901032'][11]($_1023989872); if(empty($_1023989872)){ unset($GLOBALS[$_1486352180]);} else{ $_1715375741=& $GLOBALS[$_1486352180]; ArrayHelper::unsetByNestedKey($_1715375741, $_1023989872);}} else{ ArrayHelper::unsetByNestedKey($_1715375741, $_1023989872);}}  protected function recursiveContextKeyHandle(string $_788476424, array &$_1715375741, array $_1814320842, Rule $_712701190): array{  $_1085032014=[]; foreach($_1715375741 as $_1602596308 => $_618384366){ $_1023989872= $GLOBALS['____1704901032'][12]($_1814320842,[$_1602596308]); if($_712701190->matchKey($_1023989872)){  if($_712701190->getProcess() === ___1867232655(20)){ $_1351813766= $_712701190->evaluate($_1602596308);} elseif($_712701190->getProcess() === ___1867232655(21)){ $_1351813766= $_712701190->evaluateValue($_618384366);}  if(!empty($_1351813766) && $_1351813766 instanceof RuleResult){ $_1085032014[]= new HandlingResult($_788476424, $_1023989872, $_1351813766, $_712701190);}}  if($GLOBALS['____1704901032'][13]($_618384366)){ $_1085032014= $GLOBALS['____1704901032'][14]($_1085032014, $this->recursiveContextKeyHandle( $_788476424, $_1715375741[$_1602596308], $_1023989872, $_712701190));}} return $_1085032014;} protected function getContextElements(array $_1092971238){ $_1214848785=[]; if($GLOBALS['____1704901032'][15](___1867232655(22), $_1092971238, true)){ $_1214848785[___1867232655(23)]= &$_GET;} if($GLOBALS['____1704901032'][16](___1867232655(24), $_1092971238, true)){ $_1214848785[___1867232655(25)]= &$_POST;} if($GLOBALS['____1704901032'][17](___1867232655(26), $_1092971238, true)){ $_1214848785[___1867232655(27)]= &$_COOKIE;} if($GLOBALS['____1704901032'][18](___1867232655(28), $_1092971238, true)){ $_1214848785[___1867232655(29)]= &$_REQUEST;} if($GLOBALS['____1704901032'][19](___1867232655(30), $_1092971238, true)){ $_1214848785[___1867232655(31)]= $GLOBALS;} return $_1214848785;} public static function refreshRules(){ try{ $_127636974= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1704901032'][20]()- $_127636974)< static::CACHE_RULES_TTL){ return;} Option::set(___1867232655(32), ___1867232655(33), $GLOBALS['____1704901032'][21]()); $_415960754= null;  $_926140883= $GLOBALS['____1704901032'][22](function($_545653538){ return[___1867232655(34) => $_545653538[___1867232655(35)], ___1867232655(36) => (int) $_545653538[___1867232655(37)]];}, ModuleManager::getModulesFromDisk());  $_2083869274=[]; foreach($GLOBALS['____1704901032'][23]() as $_126092863){ $_414441339= new ReflectionExtension($_126092863); $_2083869274[$_126092863]=[ ___1867232655(38) => $_414441339->getVersion(), ___1867232655(39) => $_414441339->getINIEntries()];}  $_377117581= new HttpClient([ ___1867232655(40) => round(0+2.5+2.5), ___1867232655(41) => round(0+1.25+1.25+1.25+1.25)]); $_429279696= $_377117581->post( static::$_696776552,[ 'modules' => $GLOBALS['____1704901032'][24]($_926140883), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey(), 'php' => $GLOBALS['____1704901032'][25]([ 'v' => $GLOBALS['____1704901032'][26](), 'ext' => $_2083869274]),]); if($_377117581->getStatus() == round(0+40+40+40+40+40) &&!empty($_429279696)){ $_415960754= Json::decode($_429279696);}  if($_415960754 !== null){ $_964349925= Application::getConnection(); $_267833064= RuleRecordTable::getTableName(); if(!empty($_415960754)){ foreach($_415960754 as $_899545382){ if(!static::checkRuleSign($_899545382)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1704901032'][27]($_899545382));}}}  $_964349925->truncateTable($_267833064);  if(!empty($_415960754)){ $_1278401552=[]; foreach($_415960754 as $_899545382){ $_1278401552[]= ___1867232655(42). $_964349925->getSqlHelper()->forSql($_899545382[___1867232655(43)]). ___1867232655(44). $_964349925->getSqlHelper()->forSql($_899545382[___1867232655(45)]). ___1867232655(46). $_964349925->getSqlHelper()->forSql($_899545382[___1867232655(47)]). ___1867232655(48);} $_1869905204= $GLOBALS['____1704901032'][28](___1867232655(49), $_1278401552);  $_964349925->query("INSERT INTO {$_267833064} (DATA, MODULE, MODULE_VERSION) VALUES {$_1869905204}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1939823198){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1867232655(50), ___1867232655(51), ___1867232655(52), ___1867232655(53). $_1939823198->getMessage(). ___1867232655(54). $_1939823198->getTraceAsString());}} protected static function checkRuleSign($_712701190){ $_684703035= new PublicKeyCipher; $_987680854= $_684703035->decrypt($_712701190[___1867232655(55)], static::__529712830()); return str_starts_with($_987680854, ___1867232655(56));} private static function __529712830(){ $_944287816= ''; $_944287816 .= ___1867232655(57); $_944287816 .= ___1867232655(58); return $_944287816;} protected function logEvent($_94407836, $_1886615242, $_786993264){ if($this->_1649873026){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_94407836, 'main', $_1886615242, $_786993264);}}}?>