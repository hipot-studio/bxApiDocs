<? namespace Bitrix\Main\Security\W;$GLOBALS['____910183923']= array(base64_decode('dGltZQ=='),base64_decode(''.'dGl'.'t'.'ZQ=='),base64_decode('a'.'nNvbl9k'.'Z'.'WNv'.'ZGU='),base64_decode('YX'.'JyYXlfbWVyZ2'.'U='),base64_decode(''.'am9p'.'bg'.'=='),base64_decode('am'.'9pbg'.'=='),base64_decode('am'.'9pbg='.'='),base64_decode('YX'.'J'.'yYXlfc'.'G9w'),base64_decode(''.'YXJyYXl'.'fc2hp'.'Z'.'nQ='),base64_decode('Y'.'XJyYXlfc'.'2h'.'pZn'.'Q'.'='),base64_decode('YX'.'Jy'.'YX'.'lfc2'.'hpZn'.'Q'.'='),base64_decode('YXJyYXlfc2hpZnQ'.'='),base64_decode('YXJ'.'yYXlfbWVyZ2U='),base64_decode('aXNfYXJyYX'.'k'.'='),base64_decode('YXJyYXlfbWVy'.'Z2U='),base64_decode('a'.'W5fYXJ'.'yYXk='),base64_decode('aW5f'.'Y'.'X'.'Jy'.'YXk='),base64_decode('aW5fYXJy'.'Y'.'Xk='),base64_decode('aW5fYXJyYXk'.'='),base64_decode(''.'aW'.'5fYX'.'JyYXk='),base64_decode('dG'.'l'.'tZQ'.'=='),base64_decode('dGltZQ=='),base64_decode('YXJyYXlfbWF'.'w'),base64_decode('Z2V0X2xvYWRl'.'ZF'.'9l'.'e'.'HRl'.'bnN'.'p'.'b'.'25z'),base64_decode('a'.'nNv'.'b'.'l9l'.'bmNvZ'.'GU='),base64_decode('an'.'Nvbl9lbm'.'N'.'vZ'.'GU='),base64_decode('cGhwdm'.'Vyc2'.'lvbg=='),base64_decode(''.'anNvbl'.'9lbmN'.'vZ'.'GU='),base64_decode('a'.'m9'.'pb'.'g=='));if(!function_exists(__NAMESPACE__.'\\___1956417393')){function ___1956417393($_202075804){static $_1666049154= false; if($_1666049154 == false) $_1666049154=array('V1dB'.'TExf'.'TE9DSw'.'==','c2'.'Vj'.'dXJpdH'.'k=','Y2F'.'ja'.'GU=','dHRs','RE'.'F'.'UQQ'.'==',''.'eyI=','V1dB'.'TExfT'.'E9'.'DSw'.'==',''.'c'.'2'.'VjdXJp'.'dHk=','U0'.'VDVVJJV'.'Flf'.'V1dB'.'TExfRVh'.'DRVBUSU9O',''.'Rk'.'F'.'JTF'.'9DS'.'EVDS'.'0'.'lORw='.'=','Q2FuIG5vdCBl'.'eG'.'V'.'jd'.'XRlIHd3YWxsIHJ1bGVz'.'OiA=','IFRyYW'.'NlOi'.'A'.'=',''.'UkV'.'RVUVTVF9VUkk=',''.'a2V5cw==','dm'.'FsdWVz','U0V'.'DVVJJVFlfV1dBTExfTU9'.'ESUZZ','Lg==',''.'U0V'.'DVVJJVF'.'lfV1d'.'BTE'.'xfVU5TR'.'VQ=','L'.'g='.'=',''.'U0'.'V'.'DVV'.'JJVFlfV1'.'dBTE'.'xfRVhJVA==','L'.'g==','Z2'.'x'.'vY'.'mF'.'s',''.'a2'.'V5cw==','dmFsdW'.'Vz',''.'Z'.'2V'.'0','Z2'.'V0','cG9zdA==','cG9zdA'.'==','Y29va'.'2'.'l'.'l','Y2'.'9va'.'2ll','cmVxd'.'WVz'.'dA'.'==','cm'.'V'.'xd'.'W'.'VzdA==',''.'Z2'.'xvYmFs','Z2xvYmF'.'s','bWFpbl9zZWM=','V1'.'d'.'BTEx'.'f'.'QUNUVUFMSV'.'pFX'.'1'.'JVT'.'EV'.'T','d'.'g='.'=','dmVyc2lvbg==','aQ==','aXN'.'Jbn'.'N0Y'.'Wxs'.'Z'.'WQ=','dg='.'=','aW5p','c2'.'9'.'ja'.'2'.'V0'.'VGltZW91d'.'A'.'==','c3RyZWFtVGl'.'tZW91dA==','K'.'Cc=','ZGF0YQ==','J'.'y'.'w'.'gJw='.'=','bW9kdWxl',''.'J'.'ywgJw==','bW9kdWx'.'l'.'X3ZlcnN'.'p'.'b24=','Jyk=','LCA=','U'.'0VDVVJJVF'.'lf'.'V1dBTE'.'xfRVhDRV'.'BUSU9O','bW'.'Fp'.'bg==',''.'R'.'kFJ'.'T'.'F9SRUZSRVNIS'.'U5H','Q2'.'FuIG5v'.'dCByZWZyZXN'.'oIHd'.'3YWxsIHJ1bGVzO'.'iA=',''.'IFRyYW'.'NlO'.'iA=',''.'Z'.'GF'.'0YQ==',''.'e'.'yI=',''.'LS0tLS'.'1C'.'RUdJ'.'T'.'iB'.'QVUJ'.'MS'.'UMgS0VZLS0tLS0=','Ck1J'.'SUJ'.'JakFO'.'Qmdrc'.'Whra'.'U'.'c5dzBCQVFFR'.'kFBT0'.'NBUThBTUl'.'J'.'QkNn'.'S0NBUUVB'.'c'.'ThRRTB'.'Ia'.'m1ISlVTd'.'F'.'dWNm'.'4w'.'emEK'.'Ul'.'Z'.'vTHgwMkt6YmZyY'.'lM'.'vUDZzV2'.'F4VHp3O'.'FNl'.'R1R0Yl'.'RDT3J'.'wS'.'G'.'k1UUY'.'2T1J'.'5a'.'lovWHh6'.'L0'.'tMVTFHYm9mOUNaMwo0e'.'j'.'dTa3FVdDY2aWJYdk9GQn'.'g0'.'Zn'.'cvQVBQUkdE'.'cXRtMG5EM2ZnR3N1M1'.'JlUGd3'.'Mjlp'.'O'.'Ct2bTdtd'.'EJLSlVZbDRyClZ'.'wYjZz'.'ZlpFVDlLR'.'WI2VDFIR'.'FltRXZjMWh'.'xL2lpdXl4T'.'HJaWmk'.'1U'.'TZVZ'.'m'.'Y0VUV2VEk'.'r'.'N'.'jhzc0ZSa'.'1Er'.'b3d'.'UUnkKZ'.'U9J'.'TWJGaE'.'0v'.'VVR'.'tZlZ'.'ZYlR'.'SRnk'.'yb1V'.'ROFdNemEybko1U2'.'FoemkxVUtPMWpB'.'alhUUFJyem'.'M3QWp1NjM5'.'ajF'.'PM'.'ApwcHFmb'.'T'.'V'.'4'.'Z1dsRkFKa'.'0'.'h'.'RVGdiZGQ'.'1QVdxREZ'.'R'.'a3Q5SEtrWStUbmZ'.'CTEdWTX'.'ZWeVB'.'3VE'.'h'.'OV1F'.'ZQXc0eHBnL3'.'dBC'.'l'.'p3'.'SURBUU'.'FC'.'Ci0tLS0tRU5'.'EIFB'.'VQkxJQyB'.'LRVktLS0t'.'LQ'.'==');return base64_decode($_1666049154[$_202075804]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1325680525= 'https://wwall.bitrix.info/rules.php'; protected $_449286608= true; public function handle(){ try{  $_490455281= Cache::createInstance(); $_1716815839= false; if($_490455281->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_556066184= $_490455281->getVars(); if($GLOBALS['____910183923'][0]()- $_556066184> round(0+4+4+4+4+4)){  $_125968123= Application::getConnection(); $_327674271= RuleRecordTable::getTableName(); $_125968123->truncateTable($_327674271); RuleRecordTable::cleanCache(); $_490455281->clean(___1956417393(0), ___1956417393(1));}} elseif($_490455281->startDataCache()){  $_490455281->endDataCache($GLOBALS['____910183923'][1]()); $_1716815839= true;}  $_826038732= RuleRecordTable::getList([ ___1956417393(2) =>[___1956417393(3) => round(0+720+720+720+720+720)* round(0+8+8+8)* round(0+3.5+3.5)]])->fetchAll(); foreach($_826038732 as $_2113333327){ $_72269755= new PublicKeyCipher; $_1490532140= $_72269755->decrypt($_2113333327[___1956417393(4)], static::__1220044948()); if(!str_starts_with($_1490532140, ___1956417393(5))){ continue;} $_616927844= $GLOBALS['____910183923'][2]($_1490532140, true); if(!empty($_616927844)){ $_1506015186= Rule::make($_616927844); $_913871746= $this->handleRule($_1506015186); $this->applyHandlingResults($_913871746);}}  if($_1716815839){ $_490455281->clean(___1956417393(6), ___1956417393(7));}} catch(\Throwable $_1157803203){ $this->logEvent( ___1956417393(8), ___1956417393(9), ___1956417393(10). $_1157803203->getMessage(). ___1956417393(11). $_1157803203->getTraceAsString());}}  public function handleRule(Rule $_1506015186): array{ $_913871746=[]; if($_1506015186->matchPath($_SERVER[___1956417393(12)])){  $_791771283= $this->getContextElements($_1506015186->getContext()); foreach($_791771283 as $_1087009880 => &$_1517466693){ $_913871746= $GLOBALS['____910183923'][3]($_913871746, $this->recursiveContextKeyHandle($_1087009880, $_1517466693,[], $_1506015186));}} return $_913871746;}  public function applyHandlingResults(array $_913871746){ $_791771283= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_913871746 as $_385089652){ $_1517466693=& $_791771283[$_385089652->getContextName()]; $_1481389042= $_385089652->getRuleResult(); $_1506015186= $_385089652->getRule(); if($_1481389042 instanceof ModifyResult){ if($_1506015186->getProcess() === ___1956417393(13)){  static::rewriteContextKey( $_385089652->getContextName(), $_1517466693, $_385089652->getContextKey(), $_1481389042->getCleanValue());} elseif($_1506015186->getProcess() === ___1956417393(14)){ static::rewriteContextValue( $_385089652->getContextName(), $_1517466693, $_385089652->getContextKey(), $_1481389042->getCleanValue());} $this->logEvent( ___1956417393(15), $_385089652->getContextName(), $GLOBALS['____910183923'][4](___1956417393(16), $_385089652->getContextKey()));} elseif($_1481389042 instanceof CheckResult &&!$_1481389042->isSuccess()){ if($_1481389042->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_385089652->getContextName(), $_1517466693, $_385089652->getContextKey(),); $this->logEvent( ___1956417393(17), $_385089652->getContextName(), $GLOBALS['____910183923'][5](___1956417393(18), $_385089652->getContextKey()));} elseif($_1481389042->getAction() === RuleAction::EXIT){ $this->logEvent( ___1956417393(19), $_385089652->getContextName(), $GLOBALS['____910183923'][6](___1956417393(20), $_385089652->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_449286608= false;} protected function rewriteContextKey($_1087009880, &$_1517466693, $_874271087, $_1700598298){ $_172914100= $_874271087;  $GLOBALS['____910183923'][7]($_172914100); $_172914100[]= $_1700598298; if($_1087009880 === ___1956417393(21)){ $_2085871548= $GLOBALS['____910183923'][8]($_874271087); $GLOBALS['____910183923'][9]($_172914100); if(empty($_874271087)){ $GLOBALS[$_1700598298]= $GLOBALS[$_2085871548]; unset($GLOBALS[$_2085871548]);} else{ $_1517466693=& $GLOBALS[$_2085871548]; $_2143613199= ArrayHelper::getByNestedKey($_1517466693, $_874271087);  ArrayHelper::setByNestedKey($_1517466693, $_172914100, $_2143613199);  ArrayHelper::unsetByNestedKey($_1517466693, $_874271087);}} else{ $_2143613199= ArrayHelper::getByNestedKey($_1517466693, $_874271087);  ArrayHelper::setByNestedKey($_1517466693, $_172914100, $_2143613199);  ArrayHelper::unsetByNestedKey($_1517466693, $_874271087);}} protected function rewriteContextValue($_1087009880, &$_1517466693, $_1837311983, $_2143613199){ if($_1087009880 === 'global'){ $_2085871548= $GLOBALS['____910183923'][10]($_1837311983); if(empty($_1837311983)){ $GLOBALS[$_2085871548]= $_2143613199;} else{ $_1517466693=& $GLOBALS[$_2085871548]; ArrayHelper::setByNestedKey($_1517466693, $_1837311983, $_2143613199);}} else{  ArrayHelper::setByNestedKey($_1517466693, $_1837311983, $_2143613199);}} protected function unsetContextValue($_1087009880, &$_1517466693, $_1837311983){ if($_1087009880 === 'global'){ $_2085871548= $GLOBALS['____910183923'][11]($_1837311983); if(empty($_1837311983)){ unset($GLOBALS[$_2085871548]);} else{ $_1517466693=& $GLOBALS[$_2085871548]; ArrayHelper::unsetByNestedKey($_1517466693, $_1837311983);}} else{ ArrayHelper::unsetByNestedKey($_1517466693, $_1837311983);}}  protected function recursiveContextKeyHandle(string $_1087009880, array &$_1517466693, array $_717983077, Rule $_1506015186): array{  $_913871746=[]; foreach($_1517466693 as $_166255526 => $_2143613199){ $_1837311983= $GLOBALS['____910183923'][12]($_717983077,[$_166255526]); if($_1506015186->matchKey($_1837311983)){  if($_1506015186->getProcess() === ___1956417393(22)){ $_1481389042= $_1506015186->evaluate($_166255526);} elseif($_1506015186->getProcess() === ___1956417393(23)){ $_1481389042= $_1506015186->evaluateValue($_2143613199);}  if(!empty($_1481389042) && $_1481389042 instanceof RuleResult){ $_913871746[]= new HandlingResult($_1087009880, $_1837311983, $_1481389042, $_1506015186);}}  if($GLOBALS['____910183923'][13]($_2143613199)){ $_913871746= $GLOBALS['____910183923'][14]($_913871746, $this->recursiveContextKeyHandle( $_1087009880, $_1517466693[$_166255526], $_1837311983, $_1506015186));}} return $_913871746;} protected function getContextElements(array $_1404312944){ $_595666934=[]; if($GLOBALS['____910183923'][15](___1956417393(24), $_1404312944, true)){ $_595666934[___1956417393(25)]= &$_GET;} if($GLOBALS['____910183923'][16](___1956417393(26), $_1404312944, true)){ $_595666934[___1956417393(27)]= &$_POST;} if($GLOBALS['____910183923'][17](___1956417393(28), $_1404312944, true)){ $_595666934[___1956417393(29)]= &$_COOKIE;} if($GLOBALS['____910183923'][18](___1956417393(30), $_1404312944, true)){ $_595666934[___1956417393(31)]= &$_REQUEST;} if($GLOBALS['____910183923'][19](___1956417393(32), $_1404312944, true)){ $_595666934[___1956417393(33)]= $GLOBALS;} return $_595666934;} public static function refreshRules(){ try{ $_1921720938= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____910183923'][20]()- $_1921720938)< static::CACHE_RULES_TTL){ return;} Option::set(___1956417393(34), ___1956417393(35), $GLOBALS['____910183923'][21]()); $_2132971453= null;  $_1463274304= $GLOBALS['____910183923'][22](function($_298138288){ return[___1956417393(36) => $_298138288[___1956417393(37)], ___1956417393(38) => (int) $_298138288[___1956417393(39)]];}, ModuleManager::getModulesFromDisk());  $_5393187=[]; foreach($GLOBALS['____910183923'][23]() as $_1589750475){ $_817340288= new ReflectionExtension($_1589750475); $_5393187[$_1589750475]=[ ___1956417393(40) => $_817340288->getVersion(), ___1956417393(41) => $_817340288->getINIEntries()];}  $_288750596= new HttpClient([ ___1956417393(42) => round(0+2.5+2.5), ___1956417393(43) => round(0+1.25+1.25+1.25+1.25)]); $_237843355= $_288750596->post( static::$_1325680525,[ 'modules' => $GLOBALS['____910183923'][24]($_1463274304), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey(), 'php' => $GLOBALS['____910183923'][25]([ 'v' => $GLOBALS['____910183923'][26](), 'ext' => $_5393187]),]); if($_288750596->getStatus() == round(0+100+100) &&!empty($_237843355)){ $_2132971453= Json::decode($_237843355);}  if($_2132971453 !== null){ $_125968123= Application::getConnection(); $_327674271= RuleRecordTable::getTableName(); if(!empty($_2132971453)){ foreach($_2132971453 as $_734553308){ if(!static::checkRuleSign($_734553308)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____910183923'][27]($_734553308));}}}  $_125968123->truncateTable($_327674271);  if(!empty($_2132971453)){ $_48452239=[]; foreach($_2132971453 as $_734553308){ $_48452239[]= ___1956417393(44). $_125968123->getSqlHelper()->forSql($_734553308[___1956417393(45)]). ___1956417393(46). $_125968123->getSqlHelper()->forSql($_734553308[___1956417393(47)]). ___1956417393(48). $_125968123->getSqlHelper()->forSql($_734553308[___1956417393(49)]). ___1956417393(50);} $_1411967701= $GLOBALS['____910183923'][28](___1956417393(51), $_48452239);  $_125968123->query("INSERT INTO {$_327674271} (DATA, MODULE, MODULE_VERSION) VALUES {$_1411967701}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1157803203){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1956417393(52), ___1956417393(53), ___1956417393(54), ___1956417393(55). $_1157803203->getMessage(). ___1956417393(56). $_1157803203->getTraceAsString());}} protected static function checkRuleSign($_1506015186){ $_72269755= new PublicKeyCipher; $_616927844= $_72269755->decrypt($_1506015186[___1956417393(57)], static::__1220044948()); return str_starts_with($_616927844, ___1956417393(58));} private static function __1220044948(){ $_1434177045= ''; $_1434177045 .= ___1956417393(59); $_1434177045 .= ___1956417393(60); return $_1434177045;} protected function logEvent($_1357789540, $_1157541601, $_496609647){ if($this->_449286608){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1357789540, 'main', $_1157541601, $_496609647);}}}?>